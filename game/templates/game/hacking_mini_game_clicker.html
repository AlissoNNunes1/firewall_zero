{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>{{ game.name }}</title>
    <link rel="stylesheet" href="{% static 'global.css' %}">
    <link rel="stylesheet" href="{% static 'hacking_mini_game.css' %}">
    <style>
        #hacking-game-container {
            width: 80%;
            max-width: 600px;
            margin: auto;
            text-align: center;
            background-color: #333;
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        .clicker-button {
            width: 100px;
            height: 100px;
            margin: 20px;
            background-color: #00aaff;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
        }

        .clicker-button:hover {
            background-color: #007acc;
            transform: scale(1.1);
        }

        #result {
            margin-top: 20px;
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
    <h1>{{ game.name }}</h1>
    <p>{{ game.descricao }}</p>
    <div id="hacking-game-container">
        <button id="clicker-button" class="clicker-button">Click!</button>
        <div id="result">
            <p>Clicks: <span id="click-count">0</span></p>
            <p>Machine Clicks: <span id="machine-click-count">0</span></p>
        </div>
    </div>

    <audio id="success-sound" src="{% static 'audio/success.wav' %}"></audio>
    <audio id="fail-sound" src="{% static 'audio/fail.wav' %}"></audio>

    <script>
        const configuracao = {{ configuracao|safe }};
        const clickerButton = document.getElementById('clicker-button');
        const clickCountDisplay = document.getElementById('click-count');
        const machineClickCountDisplay = document.getElementById('machine-click-count');
        const resultContainer = document.getElementById('result');
        const successSound = document.getElementById('success-sound');
        const failSound = document.getElementById('fail-sound');
        let clickCount = 0;
        let machineClickCount = 0;
        let machineClickRate;

        // Definir a taxa de cliques da máquina com base na dificuldade
        switch (configuracao.dificuldade) {
            case 'fácil':
                machineClickRate = 0.5; // 0.5 cliques por segundo
                break;
            case 'média':
                machineClickRate = 1; // 1 clique por segundo
                break;
            case 'difícil':
                machineClickRate = 2; // 2 cliques por segundo
                break;
            default:
                machineClickRate = 1; // Padrão para dificuldade média
        }

        clickerButton.addEventListener('click', () => {
            clickCount++;
            clickCountDisplay.textContent = clickCount;
            checkVictory();
        });

        function startMachineClicks() {
            setInterval(() => {
                machineClickCount += machineClickRate;
                machineClickCountDisplay.textContent = Math.floor(machineClickCount);
                checkVictory();
            }, 1000);
        }

        function checkVictory() {
            const targetClicks = configuracao.dificuldade === 'fácil' ? 20 : configuracao.dificuldade === 'média' ? 50 : configuracao.dificuldade === 'difícil' ? 100 : 50;
            if (clickCount >= targetClicks) {
                resultContainer.innerHTML = '<p>Você venceu!</p>';
                successSound.play();
                postCompletion(true);
            } else if (machineClickCount >= targetClicks) {
                resultContainer.innerHTML = '<p>A máquina venceu!</p>';
                failSound.play();
                postCompletion(false);
            }
        }

        function postCompletion(playerWon) {
            fetch("{% url 'hacking_mini_game_view' game.id %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ completed: playerWon, clicks: clickCount })
            })
            .then(response => response.json())
            .then(data => {
                if (data.next_screen_url) {
                    window.location.href = data.next_screen_url;
                } else {
                    alert(data.message);
                }
            });
        }

        startMachineClicks();
    </script>
</body>
</html>