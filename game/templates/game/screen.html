{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>{{ screen.title }}</title>
    <link rel="stylesheet" href="{% static 'global.css' %}">
    <link rel="stylesheet" href="{% static 'screen.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        {{ screen.custom_css|safe }}
        .back-to-home-icon {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 2rem;
            color: white;
            text-decoration: none;
            transition: color 0.3s, transform 0.3s;
        }
        
        .back-to-home-icon:hover {
            color: #007bff;
            transform: scale(1.1);
        }

        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .popup button {
            margin: 5px;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
    </style>
</head>
<body class="screen_background">
    <a href="#" class="back-to-home-icon" onclick="showPopup(event)">
        <i class="fas fa-home"></i>
    </a>
    <h1 class="screen_title">
        <span class="screen_description">{{ screen.title }}</span>
    </h1>
    <p class="screen_question">{{ screen.content }}</p>

    <div class="interactive_messages">
        {{ screen.mensagens_interativas|safe }}
    </div>
    <ul class="screen_answer_list">
        {% for choice in screen.choices.all %}
            {% if choice.next_screen %}
                <li class="screen_answer_item">
                    <a class="screen_answer_link" href="{% url 'screen_view' choice.next_screen.chapter.num choice.next_screen.num %}"
                       onclick="document.getElementById('update-progress-form-{{ choice.next_screen.num }}').submit();">
                        {{ choice.text }}
                    </a>
                    <form id="update-progress-form-{{ choice.next_screen.num }}" method="post" action="{% url 'update_progress' %}" style="display: none;">
                        {% csrf_token %}
                        <input type="hidden" name="next_screen_num" value="{{ choice.next_screen.num }}">
                        <input type="hidden" name="choice_id" value="{{ choice.id }}">
                    </form>
                </li>
            {% elif choice.hacking_mini_game %}
                <li class="screen_answer_item">
                    <a class="screen_answer_link" href="{% url 'hacking_mini_game_view' choice.hacking_mini_game.id %}">
                        {{ choice.text }}
                    </a>
                </li>
            {% else %}
                <li class="screen_answer_item">{{ choice.text }}</li>
            {% endif %}
        {% endfor %}
    </ul>
    {% if personagens|length > 1 %}
        <div class="character_container" style="display: flex; left: 0.5%; width: 100%; position: fixed; bottom: 5%; right: 2.5%; justify-content: space-between; align-items: center;">
            {% for personagem in personagens %}
                <div class="character_base">
                    <div id="character_{{ forloop.counter }}" style="background-image: url('{{ personagem.image.url }}');" class="character"></div>
                    <div class="character_info" style="position: absolute; bottom: 0%; left: 35%; z-index: 2;">
                        <h3>{{ personagem.name }}</h3>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% elif personagens|length == 1 %}
        <div class="character_container">
            {% with personagem=personagens.0 %}
                <div class="character_base">
                    <div style="background-image: url('{{ personagem.image.url }}');" class="character"></div>
                    <div class="character_info" style="position: absolute; bottom: 0%; left: 35%; z-index: 2;">
                        <h3>{{ personagem.name }}</h3>
                    </div>
                </div>
            {% endwith %}
        </div>
    {% endif %}
    </div>
    <div class="missions">
        {% for missao in missoes %}
            <div class="mission">
                <h2>{{ missao.tipo }}</h2>
                <p>{{ missao.descricao }}</p>
            </div>
        {% endfor %}
    </div>
    <div class="interactive_scenes">
        {% for cena in cenas_interativas %}
            <div class="interactive_scene">
                <h2>{{ cena.nome }}</h2>
                <p>{{ cena.descricao }}</p>
                <div class="mini_games">
                    {% for mini_jogo in cena.mini_jogos.all %}
                        <a href="{% url 'hacking_mini_game_view' mini_jogo.id %}">{{ mini_jogo.name }}</a>
                    {% endfor %}
                </div>
                <div class="choices">
                    {% for escolha in cena.escolhas.all %}
                        <a href="{% url 'screen_view' escolha.next_screen.chapter.num escolha.next_screen.num %}">{{ escolha.text }}</a>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>
    <div class="alignment">
        {% if alinhamento %}
            <p>Alinhamento atual: {{ alinhamento }}</p>
        {% endif %}
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="popup" id="popup">
        <p>Você quer salvar o progresso?</p>
        <button onclick="saveProgress()">Sim</button>
        <button onclick="goHome()">Não</button>
    </div>

    <script>
        {{ screen.custom_js|safe }}

        function showPopup(event) {
            event.preventDefault();
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('popup').style.display = 'block';
        }

        function hidePopup() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('popup').style.display = 'none';
        }

        function saveProgress() {
            const currentUrl = window.location.href;
            fetch("{% url 'save_progress' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `current_url=${encodeURIComponent(currentUrl)}`
            }).then(() => {
                window.location.href = "{% url 'home_view' %}";
            });
        }

        function goHome() {
            window.location.href = "{% url 'home_view' %}";
        }
    </script>
</body>
</html>